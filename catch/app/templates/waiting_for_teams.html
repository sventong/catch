{% extends 'base.html' %}

{% block content %}
{% comment %} <div id="map"></div> {% endcomment %}


<div class="container h-100 align-items-center text-center">

    <h1>WAITING FOR TEAMS</h1>
    
    <div class="row">
        <div class="col-md-6 offset-md-3">
            <div class="game-id-box">
                Game ID: {{game_id}}
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8 offset-md-2">
            Waiting for all teams to join
            <table id="teams">
                {% for t in all_teams %}
                    {% if t == team_name %}
                        <tr>
                            <th>{{t}}</th>
                            <th class="pl-4 float-right"> - Your Team </th>
                        </tr>
                    {% else %}
                        <tr>
                            <th>{{t}}</th>
                        </tr>
                    {% endif %}
                {% endfor %}
                    {% comment %} <td> Your team: </td>
                    <td> {{team_name}} </td> {% endcomment %}
            </table>
        </div>
    </div>


    {% comment %} Build websocket so that incoming teams are immediately displayed.
    Display Team Names, maybe nr of teammates. {% endcomment %}
    {% if game_master == True %}
        <div class="row">
            <div class="col-md-12 text-center">
                <a href="{% url 'game' game_id = game_id %}"> 
                    <button type="submit" class="btn btn-dark btn-lg">Start The Game!</button>
                </a>
            </div>
        </div>
    {% endif %}


    <div id="messages"></div>


</div>



{% load static %}
<script type="text/javascript"> 
    
    function connect() {

        let game_id = '{{game_id}}'
        let curr_team = '{{team_name}}'
        let url = `ws://${window.location.host}/ws/waiting/${game_id}/`
    
        const waitSocket = new WebSocket(url)
    
        waitSocket.onopen = function open() {
            console.log("WebSockets connection created.");
            waitSocket.send(JSON.stringify({
                "event": "START",
                "team_name": curr_team
            }))
        };
    
        waitSocket.onclose = function (e) {
            console.log('Socket is closed. Reconnect will be attempted in 1 second.', e.reason);
            setTimeout(function () {
                connect();
            }, 1000);
        };
    
        waitSocket.onmessage = function(e){
            let data = JSON.parse(e.data)
            console.log('Data:', data)
    
            let team_name = data['team_name']
            let event = data['event']
            console.log(curr_team)
            console.log(team_name)
            if(event === 'NEWTEAM' && curr_team !== team_name){
                let teams_div = document.getElementById('teams')
    
                teams_div.insertAdjacentHTML('beforeend', 
                                             `<div>
                                                <th>${team_name}</th>
                                             </div>`)
            }
        }
    }
    
    connect();
</script>
    

{% endblock content %}